{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consulta DJEN · Juris IA</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-u1O2Sig8C02V8anQn4P5Yuo9GhtnRwzsxIYpPD7Wv1u6vbzUKGwEuUCMCKcVn0P8ugOZBtqz9Jj4X1NYc9vicA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        background: linear-gradient(180deg, #f3f4f6, #e5e7eb 55%, #e5e7eb 100%);
        min-height: 100vh;
        color: #1f2937;
      }
      .page-wrapper {
        padding: 3rem 0 4rem;
      }
      .card {
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 10px 24px -12px rgba(0, 0, 0, 0.2);
        background-color: #ffffff;
        color: #111827;
      }
      .card-header,
      .card-footer {
        background-color: #f8fafc;
        border-color: #e2e8f0;
      }
      .form-control,
      .form-select {
        background-color: #ffffff;
        border-color: #d1d5db;
        color: #111827;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.15);
      }
      .badge {
        font-size: 0.85rem;
      }
      .result-card {
        border: 1px solid rgba(37, 99, 235, 0.18);
        background-color: #ffffff;
      }
      .result-body {
        background-color: #f8fafc;
      }
      .muted-label {
        color: #374151;
        font-weight: 600;
      }
      .text-muted {
        color: #6b7280 !important;
      }
      .alert {
        border-radius: 0.75rem;
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <div class="container-lg">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-5">
          <div>
            <h1 class="fw-semibold text-white mb-2">
              <i class="fa-solid fa-scale-balanced me-2 text-primary"></i>
              Consulta de Jurisprudência · DJEN
            </h1>
            <p class="text-muted mb-0">
              Sprint 2 · Itens T2/T8 &mdash; Pesquise por termos, tribunais e período para validar o
              coletor DJEN diretamente na aplicação Django.
            </p>
          </div>
          <div class="text-lg-end">
            <span class="badge bg-primary-subtle text-primary-emphasis px-3 py-2 fw-semibold">
              História #16 · Issue #24
            </span>
          </div>
        </div>

        {% if form.errors %}
        <div class="alert alert-danger border-0">
          <h5 class="fw-semibold"><i class="fa-solid fa-triangle-exclamation me-2"></i>Revise os filtros informados</h5>
          <ul class="mb-0 ps-3">
            {% for campo, mensagens in form.errors.items %}
              {% for mensagem in mensagens %}
                <li><strong>{{ campo }}</strong>: {{ mensagem }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <div class="card mb-5 shadow-lg" id="card-busca-djen">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fa-solid fa-magnifying-glass me-2"></i>
              Buscar julgados no DJEN
            </h5>
            <span class="badge bg-light text-dark">Consulta ao vivo</span>
          </div>
          <div class="card-body">
            <form method="get" class="row g-4" novalidate>
              <div class="col-12">
                <label for="termo" class="form-label muted-label">Termos principais *</label>
                <input
                  type="text"
                  class="form-control form-control-lg"
                  id="termo"
                  name="termo"
                  value="{{ form_data.termo }}"
                  placeholder="Ex.: tutela antecipada em contratos bancários"
                  required
                />
                <small class="text-muted">Use palavras-chave, trechos de ementa ou números de processo para refinar.</small>
              </div>

              <div class="col-lg-4">
                <label for="tribunais" class="form-label muted-label">Tribunais (CTRL + clique para múltiplos)</label>
                <select
                  class="form-select"
                  id="tribunais"
                  name="tribunais"
                  multiple
                  size="10"
                >
                  {% for tribunal in tribunais_disponiveis %}
                    <option value="{{ tribunal }}" {% if tribunal in form_data.tribunais %}selected{% endif %}>{{ tribunal }}</option>
                  {% endfor %}
                </select>
                <small class="text-muted">Selecione ao menos um tribunal. Caso nenhum seja escolhido, ocorrerá validação.</small>
              </div>

              <div class="col-lg-8">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label for="tipo_decisao" class="form-label muted-label">Tipo de decisão</label>
                    <select class="form-select" id="tipo_decisao" name="tipo_decisao">
                      {% for value, label in tipos_decisao %}
                        <option value="{{ value }}" {% if form_data.tipo_decisao == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="limite" class="form-label muted-label">Limite de resultados</label>
                    <input
                      type="number"
                      class="form-control"
                      id="limite"
                      name="limite"
                      value="{{ form_data.limite }}"
                      min="1"
                      max="200"
                    />
                    <small class="text-muted">Padrão: 25 julgados (máximo 200 por consulta).</small>
                  </div>

                  <div class="col-md-6">
                    <label for="periodo_inicio" class="form-label muted-label">Período inicial</label>
                    <input
                      type="date"
                      class="form-control"
                      id="periodo_inicio"
                      name="periodo_inicio"
                      value="{{ form_data.periodo_inicio }}"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="periodo_fim" class="form-label muted-label">Período final</label>
                    <input
                      type="date"
                      class="form-control"
                      id="periodo_fim"
                      name="periodo_fim"
                      value="{{ form_data.periodo_fim }}"
                    />
                  </div>

                  <div class="col-12">
                    <div class="d-flex flex-wrap gap-3 align-items-center pt-2">
                      <button type="submit" class="btn btn-primary btn-lg px-4">
                        <i class="fa-solid fa-search me-2"></i>
                        Consultar DJEN
                      </button>
                      <a href="{{ request.path }}" class="btn btn-outline-light px-4">
                        <i class="fa-solid fa-eraser me-2"></i>
                        Limpar filtros
                      </a>
                      <span class="text-muted small">
                        A consulta respeita o rate limit (60 req/min) e reutiliza cache quente quando disponível.
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="card-footer text-muted small">
            <i class="fa-solid fa-circle-info me-2"></i>
            Os filtros refletem diretamente o contrato usado pelos agentes especializados para ingestão de jurisprudência.
          </div>
        </div>

        {% if resultado %}
          <div class="card border-primary-subtle mb-4">
            <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
              <div>
                <h4 class="fw-semibold mb-1 text-white">
                  <i class="fa-solid fa-list-check me-2 text-primary"></i>
                  {{ resultado.quantidade }} julgados encontrados
                </h4>
                <div class="text-muted">
                  Origem: {{ origem_legenda }} · Tempo: {{ resultado.tempoExecucaoMs }} ms
                </div>
              </div>
              <span class="badge bg-primary text-white fs-6">
                {% if resultado.quantidade > 0 %}
                  Resultados prontos para análise dos agentes
                {% else %}
                  Nenhum julgado retornado
                {% endif %}
              </span>
            </div>
          </div>

          {% if resultado.quantidade > 0 %}
            <div class="row g-4" id="lista-resultados-djen">
              {% for julgado in resultado.julgados %}
                <div class="col-12">
                  <div class="card result-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="mb-0 text-white fw-semibold">
                          <i class="fa-solid fa-gavel me-2 text-primary"></i>
                          Processo {{ julgado.processo|default:julgado.id }}
                        </h5>
                        <small class="text-muted">{{ julgado.tribunal }}</small>
                      </div>
                      {% if julgado.scoreFavorabilidade %}
                        <span class="badge bg-success-subtle text-success-emphasis">
                          Favorabilidade {{ julgado.scoreFavorabilidade|floatformat:0 }}%
                        </span>
                      {% endif %}
                    </div>
                    <div class="card-body result-body">
                      <div class="row g-3 mb-3 text-muted">
                        <div class="col-sm-4">
                          <span class="muted-label d-block small">Data do julgamento</span>
                          <span>{{ julgado.dataFormatada|default:julgado.dataJulgamento|default:"—" }}</span>
                        </div>
                        <div class="col-sm-4">
                          <span class="muted-label d-block small">Vara / Órgão</span>
                          <span>{{ julgado.vara|default:"Não informado" }}</span>
                        </div>
                        <div class="col-sm-4">
                          <span class="muted-label d-block small">Relator</span>
                          <span>{{ julgado.relator|default:"Não informado" }}</span>
                        </div>
                      </div>

                      <div class="mb-3">
                        <span class="muted-label d-block small">Ementa / resumo</span>
                        <div class="mb-0" style="white-space: normal; line-height: 1.6;">{{ julgado.ementa|safe }}</div>
                      </div>

                      {% if julgado.decisao %}
                        <details class="bg-dark border border-primary-subtle rounded p-3">
                          <summary class="text-primary fw-semibold mb-2">
                            <i class="fa-solid fa-file-lines me-2"></i>
                            Ver decisão completa
                          </summary>
                          <div style="white-space: normal; line-height: 1.6;" class="text-muted">{{ julgado.decisao|safe }}</div>
                        </details>
                      {% endif %}
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                      <div class="text-muted small">
                        Classe: {{ julgado.classe|default:"—" }} · Assunto: {{ julgado.assunto|default:"—" }}
                      </div>
                      {% if julgado.url %}
                        <a href="{{ julgado.url }}" class="btn btn-outline-light btn-sm" target="_blank" rel="noopener">
                          <i class="fa-solid fa-arrow-up-right-from-square me-1"></i> Abrir no DJEN
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-warning border-0">
              <i class="fa-solid fa-exclamation-triangle me-2"></i>
              Nenhum julgado corresponde aos filtros informados. Ajuste termos, amplie o período ou selecione outros tribunais.
            </div>
          {% endif %}
        {% elif houve_busca and not erros %}
          <div class="alert alert-info border-0">
            <i class="fa-solid fa-circle-info me-2"></i>
            Consulta executada, mas não houve retorno do coletor. Tente novamente mais tarde.
          </div>
        {% endif %}

        <div class="mt-5 text-muted small">
          <p class="mb-1">Checklist Sprint 2:</p>
          <ul class="ps-4 mb-0">
            <li>Interface server-side conectada ao `DJENCollector`</li>
            <li>Rota compartilhada com os agentes (`/api/djen/search/`)</li>
            <li>Campos alinhados aos filtros priorizados (termos, tribunais, período, tipo, limite)</li>
          </ul>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
