# Fluxograma da L√≥gica de Neg√≥cio - Sistema Juris AI

## Vis√£o Geral do Sistema

O sistema Juris AI √© uma plataforma de an√°lise de jurisprud√™ncia que utiliza agentes de IA para processar e analisar julgados do DJEN (Di√°rio da Justi√ßa Eletr√¥nico Nacional). O sistema est√° organizado em sprints com funcionalidades espec√≠ficas implementadas e planejadas.

## Arquitetura do Sistema

### **Sprint 2 - Integra√ß√£o DJEN e Frontend (Conclu√≠do)**
- ‚úÖ Integra√ß√£o com DJEN API funcionando
- ‚úÖ Frontend Django com Bootstrap 5
- ‚úÖ Busca por termos implementada
- ‚úÖ Valida√ß√£o de dados e tratamento de erros
- ‚úÖ Cache Redis e rate limiting

### **Sprint 3 - Implementa√ß√£o dos Agentes (Em Andamento)**
- üîÑ **Pr√≥xima Fase**: Implementa√ß√£o do Agente Neutro
- üìã **Planejado**: AgenteClassificadorTese
- üìã **Planejado**: AgenteAnalisadorVara  
- üìã **Planejado**: AgenteEstrategicoAntecipatorio

## Fluxograma Principal

```mermaid
graph TD
    A[Usu√°rio acessa o sistema] --> B[Dashboard Django]
    B --> C[Escolhe tipo de an√°lise]
    
    C --> D[An√°lise de Jurisprud√™ncia por Tese]
    C --> E[An√°lise Neutra de Jurisprud√™ncia]
    C --> F[An√°lise de Padr√µes de Vara/Tribunal]
    C --> G[Estrat√©gia Antecipat√≥ria]
    C --> H[Busca Simples DJEN]
    
    %% Fluxo de An√°lise por Tese (PLANEJADO - Sprint 3+)
    D --> D1[Usu√°rio define tese jur√≠dica]
    D1 --> D2[Define termos de busca]
    D2 --> D3[Configura filtros e per√≠odo]
    D3 --> D4[üîÑ IMPLEMENTAR: Celery Task classificador_tese.run]
    D4 --> D5[üîÑ IMPLEMENTAR: Verifica cache Redis]
    D5 --> D6{üîÑ IMPLEMENTAR: Cache existe?}
    D6 -->|Sim| D7[üîÑ IMPLEMENTAR: Usa dados do cache]
    D6 -->|N√£o| D8[‚úÖ Integra√ß√£o com DJEN API]
    D8 --> D9[‚úÖ Rate limiting 60 req/min]
    D9 --> D10[‚úÖ Backoff exponencial]
    D10 --> D11[‚úÖ Coleta julgados relevantes]
    D11 --> D12[üîÑ IMPLEMENTAR: ContextManager - Chunking ‚â§6k tokens]
    D12 --> D13[üîÑ IMPLEMENTAR: LLM Gemini 2.5 - Classifica√ß√£o]
    D13 --> D14[üîÑ IMPLEMENTAR: Fallback GPT-4 se necess√°rio]
    D14 --> D15[üîÑ IMPLEMENTAR: Persiste em JulgadoFavoravel]
    D15 --> D16[üîÑ IMPLEMENTAR: Atualiza AnaliseJurisprudenciaTese]
    D16 --> D17[üîÑ IMPLEMENTAR: Evento: juris.analise_tese.ready]
    D17 --> D18[üîÑ IMPLEMENTAR: Relat√≥rio de Favorabilidade]
    
    %% Fluxo de An√°lise Neutra (PR√ìXIMA FASE - Sprint 3)
    E --> E1[Usu√°rio define tema jur√≠dico]
    E1 --> E2[Configura per√≠odo de an√°lise]
    E2 --> E3[üîÑ PR√ìXIMA FASE: Celery Task analisador_neutro.run]
    E3 --> E4[‚úÖ NeutralSearchAgent - Varia√ß√µes]
    E4 --> E5[‚úÖ Gera varia√ß√µes de busca]
    E5 --> E6[‚úÖ Executa m√∫ltiplas consultas DJEN]
    E6 --> E7[‚úÖ Agrega e deduplica resultados]
    E7 --> E8[üîÑ IMPLEMENTAR: Clusteriza√ß√£o TF-IDF + KMeans]
    E8 --> E9[üîÑ IMPLEMENTAR: LLM - An√°lise pr√≥/contra/neutro]
    E9 --> E10[üîÑ IMPLEMENTAR: Identifica tend√™ncia majorit√°ria]
    E10 --> E11[üîÑ IMPLEMENTAR: Persiste em AnaliseJurisprudenciaNeutra]
    E11 --> E12[üîÑ IMPLEMENTAR: Evento: analisador_neutro.completed]
    E12 --> E13[üîÑ IMPLEMENTAR: Relat√≥rio de Tend√™ncias]
    
    %% Fluxo de Padr√µes de Vara (PLANEJADO - Sprint 3+)
    F --> F1[Seleciona tribunal/vara]
    F1 --> F2[Define tema jur√≠dico]
    F2 --> F3[Configura per√≠odo]
    F3 --> F4[üîÑ IMPLEMENTAR: Celery Task analisador_vara.run]
    F4 --> F5[‚úÖ Coleta julgados hist√≥ricos]
    F5 --> F6[üîÑ IMPLEMENTAR: Extrai features estruturais]
    F6 --> F7[üîÑ IMPLEMENTAR: Estat√≠sticas descritivas]
    F7 --> F8[üîÑ IMPLEMENTAR: LLM - Padr√µes qualitativos]
    F8 --> F9[üîÑ IMPLEMENTAR: Compara com outros √≥rg√£os]
    F9 --> F10[üîÑ IMPLEMENTAR: Persiste em PadroesVaraTribunal]
    F10 --> F11[üîÑ IMPLEMENTAR: Evento: padrao_vara.updated]
    F11 --> F12[üîÑ IMPLEMENTAR: Relat√≥rio de Padr√µes]
    
    %% Fluxo de Estrat√©gia Antecipat√≥ria (PLANEJADO - Sprint 3+)
    G --> G1[Informa n√∫mero do processo]
    G1 --> G2[Define tribunal/vara de destino]
    G2 --> G3[Upload de documentos do caso]
    G3 --> G4[üîÑ IMPLEMENTAR: Celery Task estrategico_antecipatorio.run]
    G4 --> G5[üîÑ IMPLEMENTAR: Busca PadroesVaraTribunal]
    G5 --> G6{üîÑ IMPLEMENTAR: Padr√£o existe?}
    G6 -->|N√£o| G7[üîÑ IMPLEMENTAR: Dispara analisador_vara.run]
    G6 -->|Sim| G8[üîÑ IMPLEMENTAR: LLM - Extrai fatores do caso]
    G7 --> G8
    G8 --> G9[üîÑ IMPLEMENTAR: Regress√£o log√≠stica + heur√≠sticas]
    G9 --> G10[üîÑ IMPLEMENTAR: Calcula probabilidade de sucesso]
    G10 --> G11[üîÑ IMPLEMENTAR: Identifica riscos espec√≠ficos]
    G11 --> G12[üîÑ IMPLEMENTAR: Gera estrat√©gias de mitiga√ß√£o]
    G12 --> G13[üîÑ IMPLEMENTAR: Recomenda argumentos direcionados]
    G13 --> G14[üîÑ IMPLEMENTAR: Persiste em EstrategiaAntecipatoria]
    G14 --> G15[üîÑ IMPLEMENTAR: Evento: estrategia_antecipatoria.completed]
    G15 --> G16[üîÑ IMPLEMENTAR: Relat√≥rio Estrat√©gico]
    
    %% Fluxo de Busca Simples (IMPLEMENTADO - Sprint 2)
    H --> H1[‚úÖ Formul√°rio Django aprimorado]
    H1 --> H2[‚úÖ Valida√ß√£o client-side]
    H2 --> H3[‚úÖ DJENCollector.search]
    H3 --> H4[‚úÖ Cache Redis 24h]
    H4 --> H5[‚úÖ Sanitiza√ß√£o HTML]
    H5 --> H6[‚úÖ Normaliza√ß√£o de texto]
    H6 --> H7[‚úÖ Extract de metadados]
    H7 --> H8[‚úÖ Gera√ß√£o de hash √∫nico]
    H8 --> H9[‚úÖ Resultados em tempo real]
    
    %% Integra√ß√£o com DJEN (IMPLEMENTADO)
    D8 --> DJEN[DJEN API]
    E6 --> DJEN
    F5 --> DJEN
    H3 --> DJEN
    
    DJEN --> DJEN1[‚úÖ Valida√ß√£o de conectividade]
    DJEN1 --> DJEN2[‚úÖ Rate limiting 60 req/min]
    DJEN2 --> DJEN3[‚úÖ Cache Redis TTL 24h]
    DJEN3 --> DJEN4[‚úÖ Backoff exponencial]
    DJEN4 --> DJEN5[‚úÖ Retry at√© 3 vezes]
    DJEN5 --> DJEN6[‚úÖ Retorna julgados padronizados]
    
    %% Processamento de Dados (IMPLEMENTADO)
    DJEN6 --> PROC1[‚úÖ Sanitiza√ß√£o HTML - html_sanitizer]
    PROC1 --> PROC2[‚úÖ Normaliza√ß√£o - search_query]
    PROC2 --> PROC3[‚úÖ Extract de metadados]
    PROC3 --> PROC4[‚úÖ Gera√ß√£o de hash SHA256]
    PROC4 --> PROC5[‚úÖ Valida√ß√£o de integridade]
    PROC5 --> PROC6[‚úÖ Armazenamento no banco]
    
    %% Agentes de IA (STATUS ATUAL)
    PROC6 --> AGENT1[‚úÖ NeutralSearchAgent - IMPLEMENTADO]
    PROC6 --> AGENT2[üîÑ AgenteClassificadorTese - PLANEJADO]
    PROC6 --> AGENT3[üîÑ AgenteAnalisadorVara - PLANEJADO]
    PROC6 --> AGENT4[üîÑ AgenteEstrategicoAntecipatorio - PLANEJADO]
    
    %% Context Manager e LLM (PLANEJADO)
    AGENT1 --> CTX1[üîÑ IMPLEMENTAR: ContextManager - 12k tokens]
    AGENT2 --> CTX1
    AGENT3 --> CTX1
    AGENT4 --> CTX1
    
    CTX1 --> LLM1[üîÑ IMPLEMENTAR: Gemini 2.5 Primary]
    LLM1 --> LLM2{üîÑ IMPLEMENTAR: Timeout > 20s?}
    LLM2 -->|Sim| LLM3[üîÑ IMPLEMENTAR: GPT-4 Fallback]
    LLM2 -->|N√£o| LLM4[üîÑ IMPLEMENTAR: Processa resultado]
    LLM3 --> LLM4
    
    %% Valida√ß√£o e Qualidade (PARCIALMENTE IMPLEMENTADO)
    LLM4 --> VAL1[‚úÖ Valida√ß√£o de integridade - data_integrity]
    VAL1 --> VAL2[‚úÖ Verifica√ß√£o de duplicatas]
    VAL2 --> VAL3[üîÑ IMPLEMENTAR: Valida√ß√£o de scores 0-100]
    VAL3 --> VAL4[üîÑ IMPLEMENTAR: Controle de qualidade]
    VAL4 --> VAL5[üîÑ IMPLEMENTAR: Logs estruturados JSON]
    VAL5 --> RESULT[‚úÖ Resultados finais]
    
    %% Armazenamento (MODELOS CRIADOS)
    RESULT --> DB[(‚úÖ Banco de Dados)]
    DB --> DB1[‚úÖ Julgado - Base]
    DB --> DB2[‚úÖ AnaliseJurisprudenciaTese - Modelo criado]
    DB --> DB3[‚úÖ AnaliseJurisprudenciaNeutra - Modelo criado]
    DB --> DB4[‚úÖ PadroesVaraTribunal - Modelo criado]
    DB --> DB5[‚úÖ EstrategiaAntecipatoria - Modelo criado]
    DB --> DB6[‚úÖ JulgadoFavoravel - Modelo criado]
    
    %% Eventos e Notifica√ß√µes (PLANEJADO)
    DB2 --> EVT1[üîÑ IMPLEMENTAR: Evento: juris.analise_tese.ready]
    DB3 --> EVT2[üîÑ IMPLEMENTAR: Evento: analisador_neutro.completed]
    DB4 --> EVT3[üîÑ IMPLEMENTAR: Evento: padrao_vara.updated]
    DB5 --> EVT4[üîÑ IMPLEMENTAR: Evento: estrategia_antecipatoria.completed]
    
    %% Relat√≥rios e Visualiza√ß√µes (PLANEJADO)
    EVT1 --> REP1[üîÑ IMPLEMENTAR: Dashboard - M√©tricas]
    EVT2 --> REP2[üîÑ IMPLEMENTAR: Gr√°ficos Chart.js]
    EVT3 --> REP3[üîÑ IMPLEMENTAR: Exporta√ß√£o PDF/DOCX]
    EVT4 --> REP4[üîÑ IMPLEMENTAR: WebSocket - Tempo Real]
    
    %% Monitoramento e Observabilidade (PLANEJADO)
    REP1 --> MON1[üîÑ IMPLEMENTAR: Logs estruturados - juris.agentes]
    MON1 --> MON2[üîÑ IMPLEMENTAR: M√©tricas Prometheus]
    MON2 --> MON3[üîÑ IMPLEMENTAR: Health Checks]
    MON3 --> MON4[üîÑ IMPLEMENTAR: Alertas Slack/Email]
    
    %% Feedback e Aprendizado (PLANEJADO)
    REP1 --> FEED1[üîÑ IMPLEMENTAR: Usu√°rio avalia resultados]
    REP2 --> FEED1
    REP3 --> FEED1
    REP4 --> FEED1
    
    FEED1 --> ML1[üîÑ IMPLEMENTAR: Dataset rotulado para valida√ß√£o]
    ML1 --> ML2[üîÑ IMPLEMENTAR: Atualiza√ß√£o de modelos]
    ML2 --> ML3[üîÑ IMPLEMENTAR: Melhoria de algoritmos]
    ML3 --> ML4[üîÑ IMPLEMENTAR: Otimiza√ß√£o de buscas]
    ML4 --> AGENT1
```

## Componentes Principais

### 1. **Modelos de Dados Django**
- **Julgado**: Base de julgados coletados do DJEN com hash √∫nico
- **AnaliseJurisprudenciaTese**: An√°lise favor√°vel a uma tese espec√≠fica
- **AnaliseJurisprudenciaNeutra**: An√°lise neutra de tend√™ncias
- **PadroesVaraTribunal**: Padr√µes de julgamento por √≥rg√£o
- **EstrategiaAntecipatoria**: Estrat√©gias para casos espec√≠ficos
- **JulgadoFavoravel**: Relacionamento entre an√°lises e julgados

### 2. **Agentes de IA Especializados**
- **AgenteClassificadorTese**: Classifica julgados favor√°veis/desfavor√°veis com LLM
- **AgenteAnalisadorNeutro**: An√°lise neutra com NeutralSearchAgent
- **AgenteAnalisadorVara**: Mapeia padr√µes hist√≥ricos por vara/tribunal
- **AgenteEstrategicoAntecipatorio**: Calcula probabilidade de sucesso

### 3. **Integra√ß√£o DJEN Robusta**
- **DJENCollector**: Interface Python com rate limiting
- **Conectividade**: Teste automatizado de conectividade
- **Rate Limiting**: Controle rigoroso de 60 req/min
- **Cache Redis**: TTL 24h com chaves estruturadas
- **Backoff Exponencial**: Retry inteligente com fallbacks
- **Valida√ß√£o de Dados**: Verifica√ß√£o de integridade completa

### 4. **Processamento de Dados Avan√ßado**
- **html_sanitizer**: Sanitiza√ß√£o HTML robusta
- **search_query**: Normaliza√ß√£o e parsing de consultas
- **data_integrity**: Valida√ß√£o de integridade de dados
- **validation_integration**: Integra√ß√£o com fallbacks autom√°ticos
- **Gera√ß√£o de Hash SHA256**: Identifica√ß√£o √∫nica de conte√∫do

### 5. **Sistema de Filas Celery**
- **Filas Dedicadas**: `juris.classificador`, `juris.neutro`, `juris.vara`, `juris.estrategico`
- **ContextManager**: Limita√ß√£o de 12k tokens por agente
- **Chunking Inteligente**: Divis√£o em blocos ‚â§6k tokens
- **Orquestra√ß√£o**: Jobs ass√≠ncronos com eventos

### 6. **LLM e Fallbacks**
- **Gemini 2.5**: Modelo prim√°rio para todos os agentes
- **GPT-4 Fallback**: Ativa√ß√£o autom√°tica em timeout >20s
- **Prompts Especializados**: Templates espec√≠ficos por agente
- **Gest√£o de Contexto**: Limita√ß√£o inteligente de tokens

## Fluxos de Dados Detalhados

### **Entrada do Usu√°rio**
1. **Dashboard Django**: Interface responsiva com Bootstrap 5
2. **Formul√°rios Validados**: Valida√ß√£o client-side e server-side
3. **Sele√ß√£o de Agentes**: Checkboxes para m√∫ltiplos agentes
4. **Configura√ß√£o de Filtros**: Tribunais, per√≠odo, tipo de decis√£o

### **Processamento Ass√≠ncrono**
1. **Celery Tasks**: Jobs enfileirados em filas dedicadas
2. **Cache Redis**: Verifica√ß√£o de dados existentes
3. **Consulta DJEN**: Rate limiting e backoff exponencial
4. **ContextManager**: Chunking e gest√£o de tokens
5. **LLM Processing**: Gemini 2.5 com fallback GPT-4
6. **Persist√™ncia**: Transa√ß√µes at√¥micas no Django ORM

### **Sa√≠da e Eventos**
1. **Eventos Pub/Sub**: `juris.analise_tese.ready`, `analisador_neutro.completed`
2. **Relat√≥rios Estruturados**: JSON com m√©tricas detalhadas
3. **Visualiza√ß√µes**: Chart.js para gr√°ficos interativos
4. **Exporta√ß√£o**: PDF/DOCX com templates customizados
5. **WebSocket**: Atualiza√ß√µes em tempo real

## Tratamento de Erros Robusto

### **N√≠veis de Fallback**
1. **Cache Redis**: Primeira linha de defesa
2. **DJEN API**: Consulta direta com retry
3. **LLM Fallback**: Gemini ‚Üí GPT-4 em caso de timeout
4. **Dados Hist√≥ricos**: Uso de padr√µes existentes
5. **Mensagens de Erro**: User-friendly com troubleshooting

### **Monitoramento Cont√≠nuo**
- **Health Checks**: Verifica√ß√£o autom√°tica de componentes
- **Logs Estruturados**: JSON com `job_id` e `tenant_id`
- **M√©tricas Prometheus**: Lat√™ncia, tokens, erros
- **Alertas**: Slack/Email para falhas cr√≠ticas

## M√©tricas e KPIs

### **Performance**
- **SLA**: 3 minutos por job (p95) com at√© 500 julgados
- **Cache Hit Ratio**: >80% para consultas repetidas
- **Taxa de Erro**: <1% com fallbacks funcionando
- **Disponibilidade**: >99.5% com redund√¢ncia

### **Qualidade**
- **Precis√£o**: ‚â•90% para classifica√ß√£o favor√°vel/desfavor√°vel
- **Acur√°cia**: ‚â•85% para tend√™ncias neutras
- **Cobertura de Testes**: >90% com dataset rotulado
- **Satisfa√ß√£o**: >4.5/5 em feedback de usu√°rios

### **Observabilidade**
- **Logs Estruturados**: `juris.agentes` com rastreamento completo
- **M√©tricas de Neg√≥cio**: An√°lises por tipo, tribunal, per√≠odo
- **Auditoria**: Timestamp, modelo LLM, prompts e respostas
- **Escalabilidade**: 3 jobs simult√¢neos por tenant

## Arquitetura de Eventos

### **Eventos Principais**
- `juris.analise_tese.ready`: An√°lise de tese conclu√≠da
- `analisador_neutro.completed`: An√°lise neutra finalizada
- `padrao_vara.updated`: Padr√µes de vara atualizados
- `estrategia_antecipatoria.completed`: Estrat√©gia calculada

### **Consumidores de Eventos**
- **Dashboard**: Atualiza√ß√£o em tempo real
- **Notifica√ß√µes**: WebSocket para usu√°rios
- **Relat√≥rios**: Gera√ß√£o autom√°tica
- **Analytics**: M√©tricas de uso e performance

## Sprint Status e Roadmap

### **Sprint 2 - Conclu√≠do**
- ‚úÖ Integra√ß√£o DJEN API funcionando
- ‚úÖ Frontend Django com Bootstrap 5
- ‚úÖ Busca por termos implementada
- ‚úÖ NeutralSearchAgent funcional
- ‚úÖ Modelos Django criados
- ‚úÖ Cache Redis e rate limiting

### **Sprint 3 - Em Andamento (Pr√≥xima Fase)**
- üîÑ **PR√ìXIMA FASE**: Implementa√ß√£o do Agente Neutro
- üîÑ Celery Tasks para agentes
- üîÑ LLM Integration (Gemini 2.5 + GPT-4)
- üîÑ ContextManager e chunking
- üîÑ Eventos e notifica√ß√µes

### **Sprint 4+ - Planejado**
- üìã AgenteClassificadorTese
- üìã AgenteAnalisadorVara
- üìã AgenteEstrategicoAntecipatorio
- üìã API REST completa
- üìã WebSocket em tempo real
- üìã Exporta√ß√£o avan√ßada
- üìã Machine Learning cont√≠nuo
